@model IEnumerable<TmsSystem.Models.TripOffer>

@{
    ViewData["Title"] = "הצעות מחיר לטיולים";
}

<style>
    .search-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .badge-pending {
        background-color: #ffc107;
        color: #000;
    }

    .badge-approved {
        background-color: #28a745;
        color: #fff;
    }

    .badge-rejected {
        background-color: #dc3545;
        color: #fff;
    }

    .badge-cancelled {
        background-color: #6c757d;
        color: #fff;
    }

    .table td {
        vertical-align: middle;
    }

    .dropdown-menu {
        text-align: right;
    }

    .dropdown-item i {
        width: 20px;
    }
</style>

@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <strong><i class="fas fa-exclamation-triangle"></i> שגיאה:</strong> @ViewBag.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <strong><i class="fas fa-check-circle"></i> הצלחה!  </strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="container-fluid mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3><i class="fas fa-file-invoice-dollar"></i> הצעות מחיר לטיולים</h3>
            <a asp-action="Create" class="btn btn-light">
                <i class="fas fa-plus"></i> הצעת מחיר חדשה
            </a>
        </div>

        <div class="card-body">
            <!-- 🔍 תיבת חיפוש -->
            <div class="search-box">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label"><i class="fas fa-search"></i> חיפוש מהיר</label>
                        <input type="text"
                               id="searchInput"
                               class="form-control"
                               placeholder="חפש לפי מספר הצעה, לקוח או טיול..."
                               onkeyup="filterTable()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-filter"></i> סינון לפי סטטוס</label>
                        <select id="statusFilter" class="form-select" onchange="filterTable()">
                            <option value="">הכל</option>
                            <option value="Pending">ממתין</option>
                            <option value="Approved">מאושר</option>
                            <option value="Rejected">נדחה</option>
                            <option value="Cancelled">בוטל</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-calendar"></i> חודש</label>
                        <input type="month"
                               id="monthFilter"
                               class="form-control"
                               onchange="filterTable()">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> נקה סינונים
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        נמצאו <strong id="resultCount">@(Model?.Count() ?? 0)</strong> הצעות מחיר
                    </small>
                </div>
            </div>

            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover" id="offersTable">
                        <thead class="table-light">
                            <tr>
                                <th><i class="fas fa-hashtag"></i> מספר הצעה</th>
                                <th><i class="fas fa-user"></i> לקוח</th>
                                <th><i class="fas fa-map-marked-alt"></i> טיול</th>
                                <th><i class="fas fa-calendar-day"></i> תאריך יציאה</th>
                                <th><i class="fas fa-users"></i> משתתפים</th>
                                <th><i class="fas fa-dollar-sign"></i> מחיר כולל</th>
                                <th><i class="fas fa-flag"></i> סטטוס</th>
                                <th><i class="fas fa-clock"></i> תאריך יצירה</th>
                                <th><i class="fas fa-cog"></i> פעולות</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var offer in Model)
                            {
                                <tr data-offer-number="@offer.OfferNumber"
                                    data-customer="@(offer.Customer?.DisplayName ?? "")"
                                    data-trip="@(offer.Trip?.Title ?? "")"
                                    data-status="@offer.Status"
                                    data-date="@offer.DepartureDate.ToString("yyyy-MM")">

                                    <td><strong class="text-primary">@offer.OfferNumber</strong></td>
                                    <td>
                                        @if (offer.Customer != null)
                                        {
                                            <span title="@offer.Customer.Email">
                                                <i class="fas fa-user-circle"></i> @offer.Customer.DisplayName
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">לא זמין</span>
                                        }
                                    </td>
                                    <td>
                                        <strong>@(offer.Trip?.Title ?? "לא זמין")</strong>
                                        @if (offer.Trip != null)
                                        {
                                            <br>
                                            <small class="text-muted">@offer.Trip.NumberOfDays ימים</small>
                                        }
                                    </td>
                                    <td>@offer.DepartureDate.ToString("dd/MM/yyyy")</td>
                                    <td><span class="badge bg-info">@offer.Participants</span></td>
                                    <td><strong class="text-success">$@offer.TotalPrice.ToString("N2")</strong></td>
                                    <td>
                                        @{
                                            var badgeClass = offer.Status switch
                                            {
                                                "Pending" => "badge-pending",
                                                "Approved" => "badge-approved",
                                                "Rejected" => "badge-rejected",
                                                "Cancelled" => "badge-cancelled",
                                                _ => "bg-secondary"
                                            };
                                            var statusText = offer.Status switch
                                            {
                                                "Pending" => "ממתין",
                                                "Approved" => "מאושר",
                                                "Rejected" => "נדחה",
                                                "Cancelled" => "בוטל",
                                                _ => offer.Status
                                            };
                                        }
                                        <span class="badge @badgeClass" id="status-badge-@offer.TripOfferId">@statusText</span>
                                    </td>
                                    <td>
                                        @offer.CreatedAt.ToString("dd/MM/yyyy")
                                        <br><small class="text-muted">@offer.CreatedAt.ToString("HH:mm")</small>
                                    </td>
                                    <td>
                                        <!-- כפתור שינוי סטטוס -->
                                        <div class="btn-group" role="group">
                                            <button type="button"
                                                    class="btn btn-sm btn-secondary dropdown-toggle"
                                                    data-bs-toggle="dropdown"
                                                    aria-expanded="false"
                                                    title="שינוי סטטוס">
                                                <i class="fas fa-flag"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="updateStatus(@offer.TripOfferId, 'Pending', event)">
                                                        <i class="fas fa-clock text-warning"></i> ממתין
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="updateStatus(@offer.TripOfferId, 'Approved', event)">
                                                        <i class="fas fa-check text-success"></i> אשר
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="updateStatus(@offer.TripOfferId, 'Rejected', event)">
                                                        <i class="fas fa-times text-danger"></i> דחה
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="updateStatus(@offer.TripOfferId, 'Cancelled', event)">
                                                        <i class="fas fa-ban text-muted"></i> בטל
                                                    </a>
                                                </li>
                                            </ul>
                                       
                                        <div class="btn-group" role="group">
                                            <a asp-action="Details"
                                               asp-route-id="@offer.TripOfferId"
                                               class="btn btn-sm btn-info"
                                               title="צפייה">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a asp-action="Edit"
                                               asp-route-id="@offer.TripOfferId"
                                               class="btn btn-sm btn-warning"
                                               title="עריכה">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <!-- 🆕 כפתור מחיקה -->
                                            <button type="button"
                                                    class="btn btn-sm btn-danger"
                                                    title="מחיקה"
                                                    onclick="deleteOffer(@offer.TripOfferId, '@offer.OfferNumber', event)">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                            </div>
                                           
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <h5>אין הצעות מחיר במערכת</h5>
                    <p>צור את הצעת המחיר הראשונה כדי להתחיל</p>
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> צור הצעת מחיר חדשה
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Anti-Forgery Token לבקשות POST -->
@Html.AntiForgeryToken()

@section Scripts {
    <script>
        // 🔍 פונקציית חיפוש וסינון
        function filterTable() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;

            const table = document.getElementById('offersTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let visibleCount = 0;

            for (let row of rows) {
                const offerNumber = row.getAttribute('data-offer-number').toLowerCase();
                const customer = row.getAttribute('data-customer').toLowerCase();
                const trip = row.getAttribute('data-trip').toLowerCase();
                const status = row.getAttribute('data-status');
                const date = row.getAttribute('data-date');

                // בדיקת חיפוש טקסט
                const matchesSearch = searchInput === '' ||
                    offerNumber.includes(searchInput) ||
                    customer.includes(searchInput) ||
                    trip.includes(searchInput);

                // בדיקת סטטוס
                const matchesStatus = statusFilter === '' || status === statusFilter;

                // בדיקת חודש
                const matchesMonth = monthFilter === '' || date === monthFilter;

                // הצגה/הסתרה
                if (matchesSearch && matchesStatus && matchesMonth) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }

            // עדכון מונה
            document.getElementById('resultCount').textContent = visibleCount;
        }

        // 🧹 ניקוי כל הסינונים
        function clearFilters() {
            document. getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document. getElementById('monthFilter').value = '';
            filterTable();
        }

        // 🏷️ עדכון סטטוס
        function updateStatus(offerId, newStatus, event) {
            event.preventDefault();

            const statusNames = {
                'Pending': 'ממתין',
                'Approved': 'מאושר',
                'Rejected': 'נדחה',
                'Cancelled': 'בוטל'
            };

            if (confirm(`האם לשנות את הסטטוס ל'${statusNames[newStatus]}'?`)) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]'). value;

                // שליחת FormData במקום JSON
                const formData = new FormData();
                formData.append('id', offerId);
                formData.append('status', newStatus);
                formData.append('__RequestVerificationToken', token);

                console.log('📤 Sending status update:', { offerId, newStatus });

                fetch('/TripOffers/UpdateStatus', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        console.log('📥 Response status:', response.status);
                        if (! response.ok) {
                            throw new Error(`HTTP error! status: ${response. status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('📊 Response data:', data);

                        if (data.success) {
                            // עדכון הסטטוס בדף ללא רענון
                            const badge = document.getElementById(`status-badge-${offerId}`);
                            const row = badge.closest('tr');

                            // עדכון המראה של ה-badge
                            badge.className = 'badge';
                            badge.classList.add(getBadgeClass(newStatus));
                            badge.textContent = statusNames[newStatus];

                            // עדכון ה-data attribute לסינון
                            row.setAttribute('data-status', newStatus);

                            // הצגת הודעה
                            showAlert('success', data.message);
                        } else {
                            showAlert('danger', 'שגיאה: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error:', error);
                        showAlert('danger', 'שגיאה בעדכון הסטטוס: ' + error.message);
                    });
            }
            return false;
        }



        // 🗑️ מחיקת הצעה
        function deleteOffer(offerId, offerNumber, event) {
            event.preventDefault();

            if (confirm(`האם אתה בטוח שברצונך למחוק את הצעת המחיר ${offerNumber}?\n\nפעולה זו לא ניתנת לביטול! `)) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const formData = new FormData();
                formData. append('id', offerId);
                formData.append('__RequestVerificationToken', token);

                console.log('🗑️ Deleting offer:', offerId);

                fetch('/TripOffers/Delete', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        console.log('📥 Delete response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('📊 Delete response data:', data);

                        if (data.success) {
                            // הסרת השורה מהטבלה
                            const row = document.querySelector(`button[onclick*="deleteOffer(${offerId}"]`).closest('tr');
                            row.style.opacity = '0. 5';

                            setTimeout(() => {
                                row. remove();
                                filterTable(); // עדכון המונה
                                showAlert('success', 'הצעת המחיר נמחקה בהצלחה! ');
                            }, 300);
                        } else {
                            showAlert('danger', 'שגיאה: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error:', error);
                        showAlert('danger', 'שגיאה במחיקת הצעת המחיר: ' + error.message);
                    });
            }
            return false;
        }



        // פונקציית עזר לקבלת class של badge
        function getBadgeClass(status) {
            const classes = {
                'Pending': 'badge-pending',
                'Approved': 'badge-approved',
                'Rejected': 'badge-rejected',
                'Cancelled': 'badge-cancelled'
            };
            return classes[status] || 'bg-secondary';
        }

        // הצגת הודעות
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <strong>${type === 'success' ? '✓' : '✗'}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // חיפוש בזמן אמת בעת הקלדה
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
            }
        });
    </script>
}