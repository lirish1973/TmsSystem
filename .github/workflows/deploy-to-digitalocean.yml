name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch:  # מאפשר הפעלה ידנית מ-GitHub UI

jobs:
  deploy:
    name: Build and Deploy to DigitalOcean
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore dependencies
        run: dotnet restore TmsSystem/TmsSystem.csproj
      
      - name: Build application
        run: dotnet build TmsSystem/TmsSystem.csproj --configuration Release --no-restore
      
      - name: Publish application
        run: dotnet publish TmsSystem/TmsSystem.csproj --configuration Release --output ./publish --no-build
      
      - name: Create deployment package
        run: |
          cd publish
          tar -czf ../deployment.tar.gz .
          cd ..
      
      - name: Deploy to DigitalOcean Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          port: 22
          source: "deployment.tar.gz"
          target: "/tmp/"
      
      - name: Execute deployment script on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          port: 22
          script: |
            # הגדרות
            APP_DIR="/var/www/TmsSystem/TmsSystem"
            BACKUP_DIR="/var/www/TmsSystem/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # יצירת תיקיות במידת הצורך
            sudo mkdir -p $APP_DIR
            sudo mkdir -p $BACKUP_DIR
            
            # גיבוי הגרסה הקיימת
            if [ -d "$APP_DIR" ] && [ "$(ls -A $APP_DIR)" ]; then
              echo "Creating backup of existing deployment..."
              sudo tar -czf $BACKUP_DIR/backup_$TIMESTAMP.tar.gz -C $APP_DIR .
              
              # שמירת רק 5 הגיבויים האחרונים
              cd $BACKUP_DIR
              ls -t backup_*.tar.gz | tail -n +6 | xargs -r sudo rm
            fi
            
            # עצירת השירות (אם קיים)
            if sudo systemctl is-active --quiet tmssystem.service; then
              echo "Stopping TmsSystem service..."
              sudo systemctl stop tmssystem.service
            fi
            
            # ניקוי התיקייה הישנה - בטוח יותר
            if [ -d "$APP_DIR" ] && [ "$APP_DIR" = "/var/www/TmsSystem/TmsSystem" ]; then
              echo "Cleaning old deployment files..."
              sudo find $APP_DIR -mindepth 1 -delete
            else
              echo "Error: APP_DIR validation failed"
              exit 1
            fi
            
            # חילוץ הגרסה החדשה
            echo "Extracting new deployment..."
            sudo tar -xzf /tmp/deployment.tar.gz -C $APP_DIR
            
            # הגדרת הרשאות
            sudo chown -R www-data:www-data $APP_DIR
            sudo chmod -R 755 $APP_DIR
            
            # מתן הרשאות הרצה לקובץ ה-DLL
            sudo chmod +x $APP_DIR/TmsSystem.dll
            
            # ניקוי קובץ הפריסה הזמני
            rm -f /tmp/deployment.tar.gz
            
            # הפעלה מחדש של השירות
            if [ -f "/etc/systemd/system/tmssystem.service" ]; then
              echo "Starting TmsSystem service..."
              sudo systemctl start tmssystem.service
              sudo systemctl status tmssystem.service --no-pager
            else
              echo "Service file not found. Please create it manually."
            fi
            
            echo "Deployment completed successfully at $(date)"
      
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          port: 22
          script: |
            echo "Checking service status..."
            sudo systemctl status tmssystem.service --no-pager || echo "Service not configured yet"
