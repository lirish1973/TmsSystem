name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch:  # מאפשר הפעלה ידנית מ-GitHub UI

env:
  BACKUP_RETENTION_COUNT: 5  # מספר גיבויים לשמור

jobs:
  deploy:
    name: Build and Deploy to DigitalOcean
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore dependencies
        run: dotnet restore TmsSystem/TmsSystem.csproj
      
      - name: Build application
        run: dotnet build TmsSystem/TmsSystem.csproj --configuration Release --no-restore
      
      - name: Publish application
        run: dotnet publish TmsSystem/TmsSystem.csproj --configuration Release --output ./publish --no-build
      
      - name: Create deployment package
        run: |
          cd publish
          tar -czf ../deployment.tar.gz .
          cd ..
      
      - name: Deploy to DigitalOcean Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          port: 22
          source: "deployment.tar.gz"
          target: "/tmp/"
      
      - name: Execute deployment script on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          port: 22
          script: |
            # הגדרות
            APP_DIR="/var/www/TmsSystem/publish"
            BACKUP_DIR="/var/www/TmsSystem/backups"
            BACKUP_RETENTION=${{ env.BACKUP_RETENTION_COUNT }}
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # יצירת תיקיות במידת הצורך
            sudo mkdir -p "$APP_DIR"
            sudo mkdir -p "$BACKUP_DIR"
            
            # גיבוי הגרסה הקיימת
            if [ -d "$APP_DIR" ] && [ "$(ls -A $APP_DIR)" ]; then
              echo "Creating backup of existing deployment..."
              sudo tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C "$APP_DIR" .
              
              # שמירת מספר מוגדר של גיבויים אחרונים (ברירת מחדל: 5)
              cd "$BACKUP_DIR"
              KEEP_COUNT=$((BACKUP_RETENTION + 1))
              ls -t backup_*.tar.gz | tail -n +$KEEP_COUNT | xargs -r sudo rm
            fi
            
            # עצירת השירות (אם קיים)
            if sudo systemctl is-active --quiet tmssystem.service; then
              echo "Stopping TmsSystem service..."
              sudo systemctl stop tmssystem.service
            fi
            
            # שמירת תיקיית uploads לפני ניקוי (תמונות שהועלו)
            UPLOADS_DIR="$APP_DIR/wwwroot/uploads"
            TEMP_UPLOADS="/tmp/uploads_backup_$TIMESTAMP"

            if [ -d "$UPLOADS_DIR" ] && [ "$(ls -A $UPLOADS_DIR 2>/dev/null)" ]; then
              echo "Backing up uploads folder..."
              sudo mkdir -p "$TEMP_UPLOADS"
              sudo cp -r "$UPLOADS_DIR"/* "$TEMP_UPLOADS/" 2>/dev/null || true
              echo "Uploads backed up to $TEMP_UPLOADS"
              ls -la "$TEMP_UPLOADS" || true
            fi

            # ניקוי התיקייה הישנה - בטוח יותר
            if [ -d "$APP_DIR" ] && [ "$APP_DIR" = "/var/www/TmsSystem/publish" ]; then
              echo "Cleaning old deployment files..."
              sudo find "$APP_DIR" -mindepth 1 -delete
            else
              echo "Error: APP_DIR validation failed"
              exit 1
            fi

            # חילוץ הגרסה החדשה
            echo "Extracting new deployment..."
            sudo tar -xzf /tmp/deployment.tar.gz -C "$APP_DIR"

            # שחזור תיקיית uploads (תמונות שהועלו)
            if [ -d "$TEMP_UPLOADS" ] && [ "$(ls -A $TEMP_UPLOADS 2>/dev/null)" ]; then
              echo "Restoring uploads folder..."
              sudo mkdir -p "$UPLOADS_DIR"
              sudo cp -r "$TEMP_UPLOADS"/* "$UPLOADS_DIR/" 2>/dev/null || true
              sudo rm -rf "$TEMP_UPLOADS"
              echo "Uploads restored to $UPLOADS_DIR"
              ls -la "$UPLOADS_DIR" || true
            else
              echo "No uploads to restore, creating empty uploads directory..."
              sudo mkdir -p "$UPLOADS_DIR/trips"
              sudo mkdir -p "$UPLOADS_DIR/gallery"
            fi

            # הגדרת הרשאות
            sudo chown -R www-data:www-data "$APP_DIR"
            sudo chmod -R 755 "$APP_DIR"

            # ניקוי קובץ הפריסה הזמני
            rm -f /tmp/deployment.tar.gz

            # הרצת Database Migrations
            echo "Running database migrations..."
            cd "$APP_DIR"

            # בדיקה אם יש dotnet-ef מותקן גלובלית, אם לא - נתקין
            if ! command -v dotnet-ef &> /dev/null; then
              echo "Installing dotnet-ef tool..."
              sudo dotnet tool install --global dotnet-ef || true
            fi

            # הרצת migrations עם connection string מה-appsettings
            export PATH="$PATH:/root/.dotnet/tools"
            dotnet ef database update --no-build 2>/dev/null || echo "Note: Migrations may require manual run if EF tools not available"

            # הפעלה מחדש של השירות
            if [ -f "/etc/systemd/system/tmssystem.service" ]; then
              echo "Starting TmsSystem service..."
              sudo systemctl start tmssystem.service
              sudo systemctl status tmssystem.service --no-pager
            else
              echo "Service file not found. Please create it manually."
            fi
            
            echo "Deployment completed successfully at $(date)"
      
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
          port: 22
          script: |
            echo "Checking service status..."
            sudo systemctl status tmssystem.service --no-pager || echo "Service not configured yet"
